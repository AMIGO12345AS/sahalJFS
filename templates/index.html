<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoho Books Manager</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .btn-action {
            margin-right: 5px;
        }
        .tab-content {
            padding-top: 20px;
        }
        .spinner-border {
            display: none;
        }
        #loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4"><i class="fas fa-book"></i> Zoho Books Manager</h1>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button" role="tab">Invoices</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">Items</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab">Create Invoice</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <!-- Invoices Tab -->
            <div class="tab-pane fade show active" id="invoices" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Invoices List</h5>
                        <button class="btn btn-primary btn-sm float-end" onclick="fetchInvoices()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="loading-invoices" class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="table-container">
                            <table class="table table-striped table-hover" id="invoices-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Invoice No</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Due Date</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoices-body">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Items Tab -->
            <div class="tab-pane fade" id="items" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Items (Products/Services)</h5>
                        <button class="btn btn-primary btn-sm float-end" onclick="fetchItems()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="loading-items" class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="table-container">
                            <table class="table table-striped table-hover" id="items-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Rate</th>
                                        <th>Type</th>
                                        <th>Stock</th>
                                    </tr>
                                </thead>
                                <tbody id="items-body">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Create Invoice Tab -->
            <div class="tab-pane fade" id="create" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Create New Invoice</h5>
                    </div>
                    <div class="card-body">
                        <form id="invoice-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customer_id" class="form-label">Customer</label>
                                        <select class="form-control" id="customer_id" required>
                                            <option value="">Loading customers...</option>
                                        </select>
                                        <small class="form-text text-muted">Select a customer from Zoho Books.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="date" class="form-label">Invoice Date</label>
                                        <input type="date" class="form-control" id="date" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="due_date" class="form-label">Due Date</label>
                                        <input type="date" class="form-control" id="due_date" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="currency_code" class="form-label">Currency Code</label>
                                        <input type="text" class="form-control" id="currency_code" value="AED" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="notes" rows="3">Thank you for your business!</textarea>
                                    </div>
                                </div>
                            </div>
                            <h5>Line Items</h5>
                            <div id="line-items">
                                <div class="line-item row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Item Name</label>
                                        <input type="text" class="form-control item-name" placeholder="Type to search..." list="items-datalist" required>
                                        <datalist id="items-datalist">
                                            <!-- Options will be populated by JavaScript -->
                                        </datalist>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control quantity" min="1" value="1" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Rate</label>
                                        <input type="number" class="form-control rate" step="0.01" value="100.0" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-danger btn-sm w-100 remove-line"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mb-3" id="add-line">
                                <i class="fas fa-plus"></i> Add Another Line
                            </button>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-check"></i> Create Invoice
                                </button>
                            </div>
                        </form>
                        <div id="create-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-5 text-muted">
            <p>Powered by Zoho Books API & Flask</p>
        </footer>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery for easy AJAX -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Set today's date as default
        $(document).ready(function() {
            const today = new Date().toISOString().split('T')[0];
            $('#date').val(today);
            const due = new Date();
            due.setDate(due.getDate() + 30);
            $('#due_date').val(due.toISOString().split('T')[0]);

            // Fetch invoices, items, and customers on page load
            fetchInvoices();
            fetchItems();
            fetchCustomers();
        });

        // Fetch invoices via AJAX
        function fetchInvoices() {
            $('#loading-invoices').show();
            $.get('/api/invoices', function(data) {
                $('#loading-invoices').hide();
                const tbody = $('#invoices-body');
                tbody.empty();
                if (data.invoices && data.invoices.length) {
                    data.invoices.forEach(inv => {
                        const row = `
                            <tr>
                                <td>${inv.invoice_id.substring(0, 10)}...</td>
                                <td>${inv.invoice_number}</td>
                                <td>${inv.customer_name}</td>
                                <td>${inv.date}</td>
                                <td>${inv.due_date}</td>
                                <td>${inv.total} ${inv.currency_code}</td>
                                <td><span class="badge ${inv.status === 'overdue' ? 'bg-danger' : 'bg-secondary'}">${inv.status}</span></td>
                                <td>
                                    <button class="btn btn-info btn-sm btn-action" onclick="viewInvoice('${inv.invoice_id}')"><i class="fas fa-eye"></i></button>
                                    <a href="${inv.invoice_url ? inv.invoice_url : '#'}" target="_blank" class="btn btn-primary btn-sm btn-action"><i class="fas fa-external-link-alt"></i></a>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                } else {
                    tbody.append('<tr><td colspan="8" class="text-center">No invoices found.</td></tr>');
                }
            }).fail(function() {
                $('#loading-invoices').hide();
                alert('Error fetching invoices.');
            });
        }

        // Fetch items via AJAX
        function fetchItems() {
            $('#loading-items').show();
            $.get('/api/items', function(data) {
                $('#loading-items').hide();
                const tbody = $('#items-body');
                tbody.empty();
                if (data.items && data.items.length) {
                    data.items.forEach(item => {
                        const row = `
                            <tr>
                                <td>${item.item_id.substring(0, 10)}...</td>
                                <td>${item.name}</td>
                                <td>${item.description || ''}</td>
                                <td>${item.rate}</td>
                                <td>${item.product_type}</td>
                                <td>${item.available_stock !== undefined ? item.available_stock : 'N/A'}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                    // Populate items datalist
                    populateItemsDatalist(data.items);
                } else {
                    tbody.append('<tr><td colspan="6" class="text-center">No items found.</td></tr>');
                }
            }).fail(function() {
                $('#loading-items').hide();
                alert('Error fetching items.');
            });
        }

        // Populate items datalist for searchable dropdown
        function populateItemsDatalist(items) {
            const datalist = $('#items-datalist');
            datalist.empty();
            items.forEach(item => {
                datalist.append(`<option value="${item.name}">${item.name} - ${item.rate} ${item.currency_code || ''}</option>`);
            });
        }

        // Fetch customers via AJAX
        function fetchCustomers() {
            $.get('/api/customers', function(data) {
                const select = $('#customer_id');
                select.empty();
                if (data.customers && data.customers.length) {
                    select.append('<option value="">Select a customer</option>');
                    data.customers.forEach(customer => {
                        select.append(`<option value="${customer.customer_id}">${customer.customer_name} (${customer.email || ''})</option>`);
                    });
                } else {
                    select.append('<option value="">No customers found</option>');
                }
            }).fail(function() {
                alert('Error fetching customers.');
            });
        }

        // View invoice details (placeholder)
        function viewInvoice(id) {
            alert('Viewing invoice ' + id + ' (details not implemented)');
        }

        // Add line item
        $('#add-line').click(function() {
            const lineItem = `
                <div class="line-item row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control item-name" placeholder="Type to search..." list="items-datalist" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control quantity" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control rate" step="0.01" value="100.0" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm w-100 remove-line"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
            $('#line-items').append(lineItem);
        });

        // Remove line item
        $(document).on('click', '.remove-line', function() {
            $(this).closest('.line-item').remove();
        });

        // Submit invoice form
        $('#invoice-form').submit(function(event) {
            event.preventDefault();
            const lineItems = [];
            $('.line-item').each(function() {
                lineItems.push({
                    name: $(this).find('.item-name').val(),
                    quantity: parseFloat($(this).find('.quantity').val()),
                    rate: parseFloat($(this).find('.rate').val())
                });
            });
            const invoiceData = {
                customer_id: $('#customer_id').val(),
                date: $('#date').val(),
                due_date: $('#due_date').val(),
                currency_code: $('#currency_code').val(),
                notes: $('#notes').val(),
                line_items: lineItems
            };
            $.ajax({
                url: '/api/invoices',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(invoiceData),
                success: function(response) {
                    $('#create-result').html(`
                        <div class="alert alert-success">
                            <strong>Success!</strong> Invoice created with ID: ${response.invoice_id}
                            <br>Invoice Number: ${response.invoice_number}
                        </div>
                    `);
                    // Clear form? optionally
                },
                error: function(xhr) {
                    $('#create-result').html(`
                        <div class="alert alert-danger">
                            <strong>Error!</strong> ${xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'}
                        </div>
                    `);
                }
            });
        });
    </script>
</body>
</html>