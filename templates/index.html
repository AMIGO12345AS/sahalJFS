<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoho Books Manager</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .btn-action {
            margin-right: 5px;
        }

        .tab-content {
            padding-top: 20px;
        }

        .spinner-border {
            display: none;
        }

        #loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mb-4"><i class="fas fa-book"></i> Zoho Books Manager</h1>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices"
                    type="button" role="tab">Invoices</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button"
                    role="tab">Items</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button"
                    role="tab">Contacts</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button"
                    role="tab">Create Invoice</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <!-- Invoices Tab -->
            <div class="tab-pane fade show active" id="invoices" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Invoices List</h5>
                        <button class="btn btn-primary btn-sm float-end" onclick="fetchInvoices()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="loading-invoices" class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="table-container">
                            <table class="table table-striped table-hover" id="invoices-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Invoice No</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Due Date</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoices-body">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Items Tab -->
            <div class="tab-pane fade" id="items" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Items (Products/Services)</h5>
                        <button class="btn btn-primary btn-sm float-end" onclick="fetchItems()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="loading-items" class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="table-container">
                            <table class="table table-striped table-hover" id="items-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Rate</th>
                                        <th>Type</th>
                                        <th>Stock</th>
                                    </tr>
                                </thead>
                                <tbody id="items-body">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Contacts Tab -->
            <div class="tab-pane fade" id="contacts" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Contacts (Customers/Vendors)</h5>
                        <button class="btn btn-primary btn-sm float-end" onclick="fetchContacts()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="loading-contacts" class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="table-container">
                            <table class="table table-striped table-hover" id="contacts-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="contacts-body">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Invoice Tab -->
            <div class="tab-pane fade" id="create" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Create New Invoice</h5>
                    </div>
                    <div class="card-body">
                        <form id="invoice-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customer_id" class="form-label">Customer</label>
                                        <select class="form-select" id="customer_id" required>
                                            <option value="" selected disabled>Select a customer</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="date" class="form-label">Invoice Date</label>
                                        <input type="date" class="form-control" id="date" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="due_date" class="form-label">Due Date</label>
                                        <input type="date" class="form-control" id="due_date" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="currency_code" class="form-label">Currency Code</label>
                                        <input type="text" class="form-control" id="currency_code" value="AED" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="notes"
                                            rows="3">Thank you for your business!</textarea>
                                    </div>
                                </div>
                            </div>
                            <h5>Line Items</h5>
                            <div class="row mb-2 fw-bold d-none d-md-flex">
                                <div class="col-md-3">Item Name</div>
                                <div class="col-md-2" style="background-color: #fff3cd;">Provision (Est.)</div>
                                <div class="col-md-2" style="background-color: #d1e7dd;">Actual Cost</div>
                                <div class="col-md-2">Sell Rate</div>
                                <div class="col-md-1">Qty</div>
                                <div class="col-md-2">Profit (Est/Act)</div>
                            </div>
                            <div id="line-items">
                                <div class="line-item row mb-3 border-bottom pb-3">
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label d-md-none">Item Name</label>
                                        <select class="form-select item-select" required>
                                            <option value="" selected disabled>Select an item</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label d-md-none">Provision</label>
                                        <input type="number" class="form-control provision-cost" step="0.01"
                                            placeholder="Est. Cost" style="background-color: #fff3cd;">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label d-md-none">Actual Cost</label>
                                        <input type="number" class="form-control actual-cost" step="0.01"
                                            placeholder="Actual Cost" style="background-color: #d1e7dd;">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label d-md-none">Sell Rate</label>
                                        <input type="number" class="form-control rate" step="0.01" value="0.00"
                                            required>
                                    </div>
                                    <div class="col-md-1 mb-2">
                                        <label class="form-label d-md-none">Quantity</label>
                                        <input type="number" class="form-control quantity" min="1" value="1" required>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label d-md-none">Profit</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text" title="Estimated Profit">Est</span>
                                            <input type="text" class="form-control est-profit" readonly disabled>
                                        </div>
                                        <div class="input-group input-group-sm mt-1">
                                            <span class="input-group-text" title="Actual Profit">Act</span>
                                            <input type="text" class="form-control act-profit" readonly disabled>
                                        </div>
                                    </div>
                                    <div class="col-12 text-end">
                                        <button type="button" class="btn btn-danger btn-sm remove-line"><i
                                                class="fas fa-trash"></i> Remove Line</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mb-3" id="add-line">
                                <i class="fas fa-plus"></i> Add Another Line
                            </button>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-check"></i> Create Invoice
                                </button>
                            </div>
                        </form>
                        <div id="create-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-5 text-muted">
            <p>Powered by Zoho Books API & Flask</p>
        </footer>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery for easy AJAX -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Set today's date as default
        // Global maps to store data for dropdowns
        let globalItems = [];
        let globalContacts = [];

        $(document).ready(function () {
            const today = new Date().toISOString().split('T')[0];
            $('#date').val(today);
            const due = new Date();
            due.setDate(due.getDate() + 30);
            $('#due_date').val(due.toISOString().split('T')[0]);

            // Fetch invoices and items on page load
            fetchInvoices();
            fetchItemsAndPopulate();
            fetchContactsAndPopulate();
        });

        // Fetch invoices via AJAX
        function fetchInvoices() {
            $('#loading-invoices').show();
            $.get('/api/invoices', function (data) {
                $('#loading-invoices').hide();
                const tbody = $('#invoices-body');
                tbody.empty();
                if (data.invoices && data.invoices.length) {
                    data.invoices.forEach(inv => {
                        const row = `
                            <tr>
                                <td>${inv.invoice_id.substring(0, 10)}...</td>
                                <td>${inv.invoice_number}</td>
                                <td>${inv.customer_name}</td>
                                <td>${inv.date}</td>
                                <td>${inv.due_date}</td>
                                <td>${inv.total} ${inv.currency_code}</td>
                                <td><span class="badge ${inv.status === 'overdue' ? 'bg-danger' : 'bg-secondary'}">${inv.status}</span></td>
                                <td>
                                    <button class="btn btn-info btn-sm btn-action" onclick="viewInvoice('${inv.invoice_id}')"><i class="fas fa-eye"></i></button>
                                    <a href="${inv.invoice_url ? inv.invoice_url : '#'}" target="_blank" class="btn btn-primary btn-sm btn-action"><i class="fas fa-external-link-alt"></i></a>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                } else {
                    tbody.append('<tr><td colspan="8" class="text-center">No invoices found.</td></tr>');
                }
            }).fail(function () {
                $('#loading-invoices').hide();
                alert('Error fetching invoices.');
            });
        }

        // Fetch items via AJAX
        // Fetch items and populate dropdowns
        function fetchItemsAndPopulate() {
            $('#loading-items').show();
            $.get('/api/items', function (data) {
                $('#loading-items').hide();
                const tbody = $('#items-body');
                tbody.empty();

                globalItems = data.items || [];

                if (globalItems.length) {
                    globalItems.forEach(item => {
                        // Populate Table
                        const row = `
                            <tr>
                                <td>${item.item_id.substring(0, 10)}...</td>
                                <td>${item.name}</td>
                                <td>${item.description || ''}</td>
                                <td>${item.rate}</td>
                                <td>${item.product_type}</td>
                                <td>${item.available_stock !== undefined ? item.available_stock : 'N/A'}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });

                    // Populate Dropdowns
                    populateItemDropdowns();
                } else {
                    tbody.append('<tr><td colspan="6" class="text-center">No items found.</td></tr>');
                }
            }).fail(function () {
                $('#loading-items').hide();
                alert('Error fetching items.');
            });
        }

        // Helper to populate all item dropdowns
        function populateItemDropdowns(context = document) {
            const selects = $(context).find('.item-select');
            selects.each(function () {
                const select = $(this);
                // Keep existing value if any
                const currentVal = select.val();

                // Clear except placeholder
                select.find('option:not(:first)').remove();

                globalItems.forEach(item => {
                    select.append(`<option value="${item.item_id}" data-rate="${item.rate}">${item.name}</option>`);
                });

                if (currentVal) select.val(currentVal);
            });
        }

        // Fetch contacts via AJAX
        // Fetch contacts and populate dropdown
        function fetchContactsAndPopulate() {
            $('#loading-contacts').show();
            $.get('/api/contacts', function (data) {
                $('#loading-contacts').hide();
                const tbody = $('#contacts-body');
                tbody.empty();
                const contactSelect = $('#customer_id');

                globalContacts = data.contacts || [];

                if (globalContacts.length) {
                    globalContacts.forEach(contact => {
                        // Populate Table
                        const row = `
                            <tr>
                                <td>${contact.contact_id ? contact.contact_id.substring(0, 10) + '...' : ''}</td>
                                <td>${contact.contact_name || ''}</td>
                                <td>${contact.email || ''}</td>
                                <td>${contact.phone || ''}</td>
                                <td>${contact.outstanding_receivable_amount || 0} ${contact.currency_code || ''}</td>
                                <td><span class="badge ${contact.status === 'active' ? 'bg-success' : 'bg-secondary'}">${contact.status || 'unknown'}</span></td>
                            </tr>
                        `;
                        tbody.append(row);

                        // Populate Dropdown
                        contactSelect.append(`<option value="${contact.contact_id}">${contact.contact_name}</option>`);
                    });
                } else {
                    tbody.append('<tr><td colspan="6" class="text-center">No contacts found.</td></tr>');
                }
            }).fail(function () {
                $('#loading-contacts').hide();
                alert('Error fetching contacts.');
            });
        }

        // View invoice details (placeholder)
        function viewInvoice(id) {
            alert('Viewing invoice ' + id + ' (details not implemented)');
        }

        // Add line item
        // Add line item
        // Add line item
        $('#add-line').click(function () {
            const lineItem = `
                <div class="line-item row mb-3 border-bottom pb-3">
                    <div class="col-md-3 mb-2">
                        <label class="form-label d-md-none">Item Name</label>
                        <select class="form-select item-select" required>
                             <option value="" selected disabled>Select an item</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label d-md-none">Provision</label>
                        <input type="number" class="form-control provision-cost" step="0.01" placeholder="Est. Cost" style="background-color: #fff3cd;">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label d-md-none">Actual Cost</label>
                         <input type="number" class="form-control actual-cost" step="0.01" placeholder="Actual Cost" style="background-color: #d1e7dd;">
                    </div>
                    <div class="col-md-2 mb-2">
                         <label class="form-label d-md-none">Sell Rate</label>
                        <input type="number" class="form-control rate" step="0.01" value="0.00" required>
                    </div>
                    <div class="col-md-1 mb-2">
                        <label class="form-label d-md-none">Quantity</label>
                        <input type="number" class="form-control quantity" min="1" value="1" required>
                    </div>
                    <div class="col-md-2 mb-2">
                            <label class="form-label d-md-none">Profit</label>
                            <div class="input-group input-group-sm">
                            <span class="input-group-text">Est</span>
                            <input type="text" class="form-control est-profit" readonly disabled>
                            </div>
                            <div class="input-group input-group-sm mt-1">
                            <span class="input-group-text">Act</span>
                            <input type="text" class="form-control act-profit" readonly disabled>
                            </div>
                    </div>
                     <div class="col-12 text-end">
                        <button type="button" class="btn btn-danger btn-sm remove-line"><i class="fas fa-trash"></i> Remove Line</button>
                    </div>
                </div>
            `;
            const newLine = $(lineItem).appendTo('#line-items');
            populateItemDropdowns(newLine);
        });

        // Auto-fill rate on item selection and trigger recalc
        $(document).on('change', '.item-select', function () {
            const selectedOption = $(this).find('option:selected');
            const rate = selectedOption.data('rate');
            const row = $(this).closest('.line-item');
            if (rate !== undefined) {
                row.find('.rate').val(rate);
            }
            calculateRowProfit(row);
        });

        // Loop calculations on inputs
        $(document).on('input', '.rate, .provision-cost, .actual-cost', function () {
            const row = $(this).closest('.line-item');
            calculateRowProfit(row);
        });

        function calculateRowProfit(row) {
            const sellRate = parseFloat(row.find('.rate').val()) || 0;
            const provision = parseFloat(row.find('.provision-cost').val()) || 0;
            const actual = parseFloat(row.find('.actual-cost').val()) || 0;

            const estProfit = sellRate - provision;
            const actProfit = sellRate - actual;

            row.find('.est-profit').val(estProfit.toFixed(2));

            const actProfitInput = row.find('.act-profit');
            actProfitInput.val(actProfit.toFixed(2));

            // Logic: Alert if Actual Cost > Provision (Loss on Estimate)
            const actCostInput = row.find('.actual-cost');
            if (actual > 0 && actual > provision) {
                actCostInput.addClass('bg-danger text-white').removeClass('bg-success');
                // Also warn on profit if needed, but styling the cost input is direct
            } else {
                actCostInput.css('background-color', '#d1e7dd').removeClass('bg-danger text-white');
            }
        }

        // Remove line item
        $(document).on('click', '.remove-line', function () {
            $(this).closest('.line-item').remove();
        });

        // Submit invoice form
        $('#invoice-form').submit(function (event) {
            event.preventDefault();
            const lineItems = [];
            $('.line-item').each(function () {
                const prov = $(this).find('.provision-cost').val();
                const act = $(this).find('.actual-cost').val();
                const itemName = $(this).find('.item-select option:selected').text();

                // Append Provision and Actual to description
                // Note: Zoho API Description field max length check might be needed if very long
                const desc = ` [Prov: ${prov || 0}, Act: ${act || 0}]`;

                lineItems.push({
                    item_id: $(this).find('.item-select').val(),
                    name: itemName,
                    description: (itemName + desc).substring(0, 500), // Append info to description
                    quantity: parseFloat($(this).find('.quantity').val()),
                    rate: parseFloat($(this).find('.rate').val())
                });
            });
            const invoiceData = {
                customer_id: $('#customer_id').val(),
                date: $('#date').val(),
                due_date: $('#due_date').val(),
                currency_code: $('#currency_code').val(),
                notes: $('#notes').val(),
                line_items: lineItems
            };
            $.ajax({
                url: '/api/invoices',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(invoiceData),
                success: function (response) {
                    $('#create-result').html(`
                        <div class="alert alert-success">
                            <strong>Success!</strong> Invoice created with ID: ${response.invoice_id}
                            <br>Invoice Number: ${response.invoice_number}
                        </div>
                    `);
                    // Clear form? optionally
                },
                error: function (xhr) {
                    $('#create-result').html(`
                        <div class="alert alert-danger">
                            <strong>Error!</strong> ${xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'}
                        </div>
                    `);
                }
            });
        });
    </script>
</body>

</html>